<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Include Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1>Portfolio Details</h1>
            <a href="{% url 'main' %}" class="btn btn-secondary">Back to Main Menu</a>
        </div>
        <div class="d-flex justify-content-between align-items-center mb-3">
            <form method="post" id="refreshForm">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary">Refresh Data</button>
            </form>
            <!-- Button to trigger analysis -->
            <button id="generateAnalysisBtn" class="btn btn-info">Generate Analysis</button>
        </div>
        <!-- Summary Section -->
        <div class="mb-4">
            <h2>Summary</h2>
            <div class="row mb-4 summary-grid">
                <div class="col-md-3 text-center">
                    <div class="card p-3">
                        <h5 class="card-title">Total Investment</h5>
                        <p class="card-text display-4"><strong>{{ total_investment|floatformat:2 }} </strong></p><t>EUR</t>
                
                    </div>
                </div>
                <div class="col-md-3 text-center">
                    <div class="card p-3">
                        <h5 class="card-title">Total Profit</h5>
                        <p class="card-text display-4 {% if total_profit >= 0 %}text-success{% else %}text-danger{% endif %}"><strong>{{ total_profit|floatformat:2 }} </strong></p><t>EUR</t>
                    </div>
                </div>
                <div class="col-md-3 text-center">
                    <div class="card p-3">
                        <h5 class="card-title">Total FX Profit</h5>
                        <p class="card-text display-4 {% if total_fx_profit >= 0 %}text-success{% else %}text-danger{% endif %}"><strong>{{ total_fx_profit|floatformat:2 }} </strong></p><t>EUR</t>
                    </div>
                </div>
                <div class="col-md-3 text-center">
                    <div class="card p-3">
                        <h5 class="card-title">Gain/Loss %</h5>
                        <p class="card-text display-4 {% if total_gain_loss_percent >= 0 %}text-success{% else %}text-danger{% endif %}"><strong>{{ total_gain_loss_percent|floatformat:2 }}%</strong></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Row for Charts -->
        <div class="row mb-4">
            <!-- Pie Chart Column -->
            <div class="col-md-6"> <!-- Adjusted column size for pie chart -->
                <div id="pieChartContainer" style="width: 100%; height: 350px;"> <!-- Made pie chart smaller -->
                    <canvas id="portfolioPieChart"></canvas>
                </div>
            </div>

            <!-- Bar Chart Column -->
            <div class="col-md-6"> <!-- Column for the new bar chart -->
                <div id="barChartContainer" style="width: 100%; height: 350px;">
                    <canvas id="profitBarChart"></canvas>
                </div>
            </div>
        </div>



        {% if success_message %}
            <div class="alert alert-success" role="alert">
                {{ success_message }}
            </div>
        {% endif %}

        {% if error_message %}
            <div class="alert alert-danger" role="alert">
                {{ error_message }}
            </div>
        {% endif %}

        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Ticker</th>
                        <th>Name</th>
                        <th>Quantity</th>
                        <th>Avg Price</th>
                        <th>Current Price</th>
                        <th>Value</th>
                        <th>Profit</th>
                        <th>FX Profit</th>
                        <th>Currency</th>
                        <th>Avg Price (EUR)</th>
                        <th>Current Price (EUR)</th>
                        <th>Value (EUR)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for holding in holdings %}
                    <tr>
                        <td>{{ holding.ticker }}</td>
                        <td>{{ holding.name }}</td>
                        <td>{{ holding.quantity|floatformat:2 }}</td>
                        <td>{{ holding.average_price|floatformat:2 }}</td>
                        <td>{{ holding.current_price|floatformat:2 }}</td>
                        <td>{{ holding.value|floatformat:2 }}</td>
                        <td class="{% if holding.profit >= 0 %}text-success{% else %}text-danger{% endif %}">{{ holding.profit|floatformat:2 }}</td>
                        <td class="{% if holding.fx_profit >= 0 %}text-success{% else %}text-danger{% endif %}">{{ holding.fx_profit|floatformat:2 }}</td>
                        <td>{{ holding.currency_code }}</td>
                        <td>{{ holding.average_price_eur|floatformat:2 }}</td>
                        <td>{{ holding.current_price_eur|floatformat:2 }}</td>
                        <td>{{ holding.value_eur|floatformat:2 }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="12" class="text-center">No portfolio data available. Click "Refresh Data" to fetch it.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Section to display analysis results -->
        <div id="analysisResults" class="mt-5" style="display: none;">
            <h2>Generated Analysis</h2>
            
            <!-- Detailed Portfolio Summary -->
            <div class="card mb-4">
                <div class="card-header">
                    Detailed Portfolio Summary
                </div>
                <div class="card-body">
                    <pre id="detailedSummaryContent"></pre>
                </div>
            </div>

            <!-- Portfolio Summary -->
            <div class="card mb-4">
                <div class="card-header">
                    Concise Portfolio Summary
                </div>
                <div class="card-body">
                    <p id="portfolioSummaryContent"></p>
                </div>
            </div>

            <!-- News by Topic -->
            <div class="card mb-4">
                <div class="card-header">
                    Daily News Insights
                </div>
                <div class="card-body">
                    <div id="newsContent"></div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // CSRF Token retrieval for AJAX requests
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // Pie Chart Data and Rendering
        const pieChartData = JSON.parse('{{ portfolio_chart_data|escapejs }}');
        const pieLabels = Object.keys(pieChartData);
        const pieDataValues = Object.values(pieChartData);

        const pieCtx = document.getElementById('portfolioPieChart').getContext('2d');
        const portfolioPieChart = new Chart(pieCtx, {
            type: 'pie',
            data: {
                labels: pieLabels,
                datasets: [{
                    data: pieDataValues,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    title: { display: true, text: 'Portfolio Value Distribution by Type' }
                },
                // Tooltip configuration to show values on hover for Pie Chart
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) {
                                label += ': ';
                            }
                            // context.parsed.value is the actual value for pie chart slices
                            if (context.parsed && context.parsed.value !== null) {
                                label += context.parsed.value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' EUR';
                            }
                            return label;
                        }
                    }
                }
            }
        });

        // Bar Chart Data and Rendering
        const barChartData = JSON.parse('{{ profit_bar_chart_data|escapejs }}');
        const barLabels = barChartData.shortName;
        // const barType = barChartData.type; // Not used in current bar chart setup
        const barProfit = barChartData.profit;
        // const barOrder = barChartData.profit_order; // Not directly used in Chart.js rendering

        const barCtx = document.getElementById('profitBarChart').getContext('2d');
        const profitBarChart = new Chart(barCtx, {
            type: 'bar',
            data: {
                labels: barLabels,
                datasets: [{
                    label: 'Profit', // Changed label to be more generic as 'type' is not used for grouping here
                    data: barProfit,
                    backgroundColor: 'rgba(75, 192, 192, 0.7)', // Example color
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }, // Hide legend as it's not needed for a single dataset bar chart
                    title: { display: true, text: 'Portfolio Profit by Ticker' }
                },
                scales: {
                    x: {
                        title: { display: true, text: 'Ticker' },
                        ticks: {
                            autoSkip: false, // Prevent skipping labels if they are too many
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        title: { display: true, text: 'Total Profit' },
                        beginAtZero: true
                    }
                },
                // Tooltip configuration to show values on hover for Bar Chart
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            // context.raw is the value for the bar
                            label += context.raw.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' EUR';
                            return label;
                        }
                    }
                }
            }
        });

        // --- AJAX call for Generate Analysis ---
        document.getElementById('generateAnalysisBtn').addEventListener('click', function(event) {
            event.preventDefault(); // Prevent default button action

            const analysisResultsDiv = document.getElementById('analysisResults');
            const detailedSummaryContent = document.getElementById('detailedSummaryContent');
            const portfolioSummaryContent = document.getElementById('portfolioSummaryContent');
            const newsContent = document.getElementById('newsContent');

            // Clear previous results and show loading state
            analysisResultsDiv.style.display = 'block'; // Make the results section visible
            detailedSummaryContent.textContent = 'Loading analysis...';
            portfolioSummaryContent.textContent = 'Loading analysis...';
            newsContent.innerHTML = 'Loading analysis...';

            fetch('/portfolio/generate-analysis/', { // URL for the new view
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                // No body needed for this POST request as it doesn't take specific parameters from the client
            })
            .then(response => {
                if (!response.ok) {
                    // If response is not ok, try to get error message from response JSON
                    return response.json().then(data => {
                        throw new Error(data.error || `HTTP error! status: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                // Display Detailed Portfolio Summary
                // Gemini returns JSON for detailed summary, so we can format it nicely
                if (data.detailed_portfolio_summary) {
                    // Assuming detailed_portfolio_summary is a JSON object that can be stringified
                    // For better readability, we can parse and then stringify with indentation
                    try {
                        const detailedSummaryJson = JSON.parse(data.detailed_portfolio_summary);
                        detailedSummaryContent.textContent = JSON.stringify(detailedSummaryJson, null, 2); // Pretty print JSON
                    } catch (e) {
                        // If it's not valid JSON, display as is
                        detailedSummaryContent.textContent = data.detailed_portfolio_summary;
                    }
                } else {
                    detailedSummaryContent.textContent = 'Detailed summary not available.';
                }

                // Display Portfolio Summary
                if (data.portfolio_summary) {
                    portfolioSummaryContent.textContent = data.portfolio_summary;
                } else {
                    portfolioSummaryContent.textContent = 'Portfolio summary not available.';
                }

                // Display News by Topic
                if (data.news_by_topic && data.news_by_topic.length > 0) {
                    let newsHtml = '';
                    data.news_by_topic.forEach(item => {
                        newsHtml += `<h4>${item.topic}</h4>`;
                        if (item.content) {
                            newsHtml += `<p>${item.content}</p>`;
                        } else if (item.error) {
                            newsHtml += `<p class="text-danger">Error: ${item.error}</p>`;
                        } else {
                            newsHtml += `<p>No content available for this topic.</p>`;
                        }
                        newsHtml += '<hr>'; // Separator between topics
                    });
                    newsContent.innerHTML = newsHtml;
                } else {
                    newsContent.textContent = 'No news available.';
                }
            })
            .catch(error => {
                console.error('Error generating analysis:', error);
                detailedSummaryContent.textContent = 'Error loading analysis.';
                portfolioSummaryContent.textContent = `Error: ${error.message}`;
                newsContent.innerHTML = `<p class="text-danger">Failed to load analysis. Please try again later.</p>`;
            });
        });
    </script>
</body>
</html>
